name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: AI Code Review
        uses: actions/github-script@v7
        with:
          script: |
            const OPENROUTER_API_KEY = '${{ secrets.OPENROUTER_API_KEY }}';

            const diff = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: context.payload.pull_request.base.sha,
              head: context.payload.pull_request.head.sha
            });

            // ë¦¬ë·°í•  íŒŒì¼ í•„í„°ë§
            const filesToReview = diff.data.files.filter(file =>
              file.patch && 
              !file.filename.includes('node_modules/') &&
              !file.filename.includes('.expo/') &&
              !file.filename.includes('dist/') &&
              !file.filename.endsWith('.lock') &&
              !file.filename.endsWith('.log')
            );

            if (filesToReview.length === 0) {
              console.log('No files to review');
              return;
            }

            // íŒŒì¼ ë¶„ë¥˜ (ì‹¤ì œ í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •)
            const tsxFiles = filesToReview.filter(f => f.filename.endsWith('.tsx'));
            const tsFiles = filesToReview.filter(f => f.filename.endsWith('.ts'));
            const appFiles = filesToReview.filter(f => f.filename.includes('app/'));
            const componentFiles = filesToReview.filter(f => f.filename.includes('components/'));
            const hookFiles = filesToReview.filter(f => f.filename.includes('hooks/'));
            const serviceFiles = filesToReview.filter(f => f.filename.includes('services/'));
            const storeFiles = filesToReview.filter(f => f.filename.includes('store/'));

            // ì „ì²´ ë³€ê²½ì‚¬í•­ ìˆ˜ì§‘
            let allChanges = '';
            const filesSummary = [];
            
            for (const file of filesToReview) {
              // ì‹¤ì œ íŒŒì¼ì˜ ì „ì²´ ë¼ì¸ ìˆ˜ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ íŒŒì¼ ë‚´ìš© ì¡°íšŒ
              let totalLines = 0;
              try {
                const fileContent = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: file.filename,
                  ref: context.payload.pull_request.head.sha
                });
                
                if (fileContent.data.content) {
                  const content = Buffer.from(fileContent.data.content, 'base64').toString('utf-8');
                  totalLines = content.split('\n').length;
                }
              } catch (e) {
                totalLines = file.additions; // ìƒˆ íŒŒì¼ì˜ ê²½ìš°
              }
              
              filesSummary.push(`- ${file.filename} (+${file.additions}/-${file.deletions}) [ì´ ${totalLines}ì¤„]`);
              allChanges += `\n### ${file.filename}\n`;
              allChanges += `\`\`\`diff\n${file.patch}\n\`\`\`\n`;
            }

            // AI ë¦¬ë·° ìš”ì²­
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'openrouter/sonoma-sky-alpha',
                messages: [{
                  role: 'system',
                  content: `React Native í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤.

                  ## ğŸ”´ ì ˆëŒ€ ê·œì¹™ ì²´í¬ë¦¬ìŠ¤íŠ¸
                  
                  ### 1. Component Architecture
                  - [ ] ì»´í¬ë„ŒíŠ¸ê°€ 300ì¤„ì„ ì´ˆê³¼í•˜ëŠ”ê°€? â†’ ë¶„ë¦¬ ê²€í†  (ë³µì¡í•œ ìƒíƒœ ê´€ë¦¬ëŠ” ì˜ˆì™¸)
                  - [ ] ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì— React.memo()ê°€ ì ìš©ë˜ì—ˆëŠ”ê°€?
                  - [ ] StyleSheet.create()ë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€? (style={{}} ì§ì ‘ ê°ì²´ ë¦¬í„°ëŸ´ë§Œ ê¸ˆì§€)
                  - [ ] Props ì¸í„°í˜ì´ìŠ¤ê°€ ëª…í™•íˆ ì •ì˜ë˜ì—ˆëŠ”ê°€?
                  - [ ] ì£¼ì˜: style={[styles.base, { dynamic: value }]} íŒ¨í„´ì€ React Nativeì—ì„œ ì •ìƒ! SafeAreaInsets ë“± ë™ì  ê°’ì€ ë³‘í•© í•„ìš”
                  
                  ### 2. TypeScript Rules  
                  - [ ] 'any' íƒ€ì…ì„ ì‚¬ìš©í•œ ê³³ì´ ìˆëŠ”ê°€? â†’ ì ˆëŒ€ ê¸ˆì§€
                  - [ ] null/undefined ì²´í¬ê°€ ë˜ì–´ìˆëŠ”ê°€?
                  - [ ] import typeì„ ì‚¬ìš©í•˜ì—¬ íƒ€ì…ì„ importí–ˆëŠ”ê°€?
                  - [ ] @/ ì ˆëŒ€ ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?
                  - [ ] catch (_error) ëŒ€ì‹  catch (error: unknown)ì„ ì‚¬ìš©í•˜ëŠ”ê°€? â†’ _error ê¸ˆì§€
                  
                  ### 3. State Management
                  - [ ] 3ë‹¨ê³„ ì´ìƒ prop drillingì´ ìˆëŠ”ê°€? â†’ Zustand ì‚¬ìš© (2ë‹¨ê³„ëŠ” ì •ìƒ)
                  - [ ] ì„œë²„ ë°ì´í„°ëŠ” React Queryë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?
                  - [ ] ì „ì—­ ìƒíƒœëŠ” Zustandë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?
                  
                  ### 4. React Native Specific
                  - [ ] ê¸´ ëª©ë¡ì— FlatListë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€? (ScrollView ê¸ˆì§€)
                  - [ ] í‚¤ë³´ë“œ ì…ë ¥ì‹œ KeyboardAvoidingViewë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?
                  - [ ] Platform.OSë¡œ í”Œë«í¼ ë¶„ê¸°ë¥¼ ì²˜ë¦¬í•˜ëŠ”ê°€?
                  - [ ] SafeAreaView ë˜ëŠ” useSafeAreaInsetsë¡œ ë…¸ì¹˜ ì²˜ë¦¬í•˜ëŠ”ê°€? (ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì‚¬ìš©)
                  
                  ### 5. Performance
                  - [ ] ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì— useCallbackì„ ì‚¬ìš©í•˜ëŠ”ê°€?
                  - [ ] ë³µì¡í•œ ê³„ì‚°ì— useMemoë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?
                  - [ ] ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì»´í¬ë„ŒíŠ¸ì— React.memoë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?
                  
                  ### 6. API Communication
                  - [ ] services/ í´ë”ì˜ API í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?
                  - [ ] ì—ëŸ¬ ì²˜ë¦¬ê°€ ë˜ì–´ìˆëŠ”ê°€?
                  - [ ] ë¡œë”© ìƒíƒœë¥¼ ì²˜ë¦¬í•˜ëŠ”ê°€?
                  
                  ê° íŒŒì¼ë³„ë¡œ ìœ„ ì²´í¬ë¦¬ìŠ¤íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ë¦¬ë·°í•˜ê³ ,
                  ğŸ”´ ë°˜ë“œì‹œ ìˆ˜ì • í•„ìš”í•œ ì‚¬í•­ (ì‹¤ì œ ë²„ê·¸ë‚˜ ì„±ëŠ¥ ë¬¸ì œ)
                  ğŸŸ¡ ê°œì„  ê¶Œì¥ ì‚¬í•­ (ë” ë‚˜ì€ íŒ¨í„´ ì œì•ˆ)
                  ğŸŸ¢ ì˜ ì‘ì„±ëœ ë¶€ë¶„
                  ìœ¼ë¡œ êµ¬ë¶„í•´ì„œ ë¦¬ë·°í•´ì£¼ì„¸ìš”.
                  
                  ì¤‘ìš”: React Nativeì˜ ì •ìƒì ì¸ íŒ¨í„´ì„ ë¬¸ì œë¡œ ì§€ì í•˜ì§€ ë§ˆì„¸ìš”:
                  - style={[styles.base, { dynamic }]}ëŠ” ì •ìƒ
                  - useSafeAreaInsetsì™€ SafeAreaViewëŠ” ë™ì¼ ê¸°ëŠ¥ (ì¤‘ë³µ ì‚¬ìš© ë¶ˆí•„ìš”)
                  - 2ë‹¨ê³„ prop drillingì€ ì •ìƒ (3ë‹¨ê³„ë¶€í„° ë¬¸ì œ)`
                }, {
                  role: 'user',
                  content: `ë‹¤ìŒ ${filesToReview.length}ê°œ íŒŒì¼ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”:
                  
                  íŒŒì¼ ëª©ë¡:
                  ${filesSummary.join('\n')}
                  
                  ë¶„ë¥˜:
                  - App (ë¼ìš°íŒ…): ${appFiles.length}ê°œ
                  - ì»´í¬ë„ŒíŠ¸: ${componentFiles.length}ê°œ
                  - Hooks: ${hookFiles.length}ê°œ  
                  - Services: ${serviceFiles.length}ê°œ
                  - Store (ìƒíƒœê´€ë¦¬): ${storeFiles.length}ê°œ
                  - TypeScript: ${tsFiles.length}ê°œ
                  - TSX: ${tsxFiles.length}ê°œ
                  
                  ë³€ê²½ì‚¬í•­:
                  ${allChanges}
                  
                  ì ˆëŒ€ ê·œì¹™ ìœ„ë°˜ì‚¬í•­ì„ ì¤‘ì ì ìœ¼ë¡œ ì²´í¬í•´ì£¼ì„¸ìš”.`
                }],
                max_tokens: 10000,
                temperature: 0.3
              })
            });

            let reviewBody = `# ğŸ¤– AI ì½”ë“œ ë¦¬ë·°\n\n`;
            reviewBody += `## ğŸ“Š ë³€ê²½ í†µê³„\n`;
            reviewBody += `- **ì´ íŒŒì¼**: ${filesToReview.length}ê°œ\n`;
            reviewBody += `- **ì¶”ê°€ëœ ë¼ì¸**: +${diff.data.files.reduce((sum, f) => sum + f.additions, 0)}\n`;
            reviewBody += `- **ì‚­ì œëœ ë¼ì¸**: -${diff.data.files.reduce((sum, f) => sum + f.deletions, 0)}\n`;
            reviewBody += `- **App**: ${appFiles.length}ê°œ | **ì»´í¬ë„ŒíŠ¸**: ${componentFiles.length}ê°œ | **Hooks**: ${hookFiles.length}ê°œ | **Services**: ${serviceFiles.length}ê°œ | **Store**: ${storeFiles.length}ê°œ\n\n`;

            if (response.ok) {
              const result = await response.json();
              reviewBody += result.choices[0].message.content;
            } else {
              reviewBody += `âš ï¸ ë¦¬ë·° ì‹¤íŒ¨: ${response.status}`;
            }
            
            // ìë™ ì²´í¬ ì¶”ê°€
            reviewBody += `\n\n## âœ… ìë™ ì²´í¬ë¦¬ìŠ¤íŠ¸\n`;
            reviewBody += `- [ ] \`npm run lint\` ì‹¤í–‰í–ˆëŠ”ê°€?\n`;
            reviewBody += `- [ ] \`npx tsc --noEmit\` íƒ€ì… ì²´í¬ í†µê³¼í•˜ëŠ”ê°€?\n`;
            reviewBody += `- [ ] 300ì¤„ ë„˜ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ì—†ëŠ”ê°€?\n`;
            reviewBody += `- [ ] ëª¨ë“  ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì— React.memo ì ìš©í–ˆëŠ”ê°€?\n`;
            reviewBody += `- [ ] any íƒ€ì… ì‚¬ìš©í•œ ê³³ì´ ì—†ëŠ”ê°€?\n`;

            // PR ë¦¬ë·° ì œì¶œ
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: reviewBody,
              event: 'COMMENT'
            });

            console.log('âœ… Review completed!');