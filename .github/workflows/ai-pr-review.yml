name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: AI Code Review
        uses: actions/github-script@v7
        with:
          script: |
            const OPENROUTER_API_KEY = '${{ secrets.OPENROUTER_API_KEY }}';

            const diff = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: context.payload.pull_request.base.sha,
              head: context.payload.pull_request.head.sha
            });

            // ë¦¬ë·°í•  íŒŒì¼ í•„í„°ë§
            const filesToReview = diff.data.files.filter(file =>
              file.patch && // íŒ¨ì¹˜ê°€ ìˆëŠ” íŒŒì¼ë§Œ
              !file.filename.includes('node_modules/') &&
              !file.filename.includes('.expo/') &&
              !file.filename.includes('dist/') &&
              !file.filename.endsWith('.lock') &&
              !file.filename.endsWith('.log')
            );

            if (filesToReview.length === 0) {
              console.log('No files to review');
              return;
            }

            console.log(`Found ${filesToReview.length} files to review`);

            // íŒŒì¼ íƒ€ì…ë³„ ë¶„ë¥˜
            const fileCategories = {
              screens: [],      // app/ í´ë”ì˜ í™”ë©´ë“¤
              components: [],   // ì»´í¬ë„ŒíŠ¸
              services: [],     // API ì„œë¹„ìŠ¤
              hooks: [],        // Custom Hooks
              stores: [],       // Zustand ìŠ¤í† ì–´
              types: [],        // TypeScript íƒ€ì…
              configs: [],      // ì„¤ì • íŒŒì¼
              others: []
            };

            filesToReview.forEach(file => {
              if (file.filename.includes('app/')) fileCategories.screens.push(file);
              else if (file.filename.includes('components/')) fileCategories.components.push(file);
              else if (file.filename.includes('services/')) fileCategories.services.push(file);
              else if (file.filename.includes('hooks/')) fileCategories.hooks.push(file);
              else if (file.filename.includes('store/')) fileCategories.stores.push(file);
              else if (file.filename.includes('types/')) fileCategories.types.push(file);
              else if (file.filename.endsWith('.json') || file.filename.endsWith('.yml')) fileCategories.configs.push(file);
              else fileCategories.others.push(file);
            });

            // ì „ì²´ ë³€ê²½ì‚¬í•­ ìš”ì•½
            const summary = {
              total: filesToReview.length,
              additions: diff.data.files.reduce((sum, f) => sum + f.additions, 0),
              deletions: diff.data.files.reduce((sum, f) => sum + f.deletions, 0),
              categories: Object.entries(fileCategories).filter(([_, files]) => files.length > 0)
                .map(([category, files]) => `${category}: ${files.length}ê°œ`)
            };

            // PR ì „ì²´ ë¦¬ë·° ì‹œì‘
            let overallReview = `# ğŸ¤– AI ì½”ë“œ ë¦¬ë·° ë³´ê³ ì„œ\n\n`;
            overallReview += `## ğŸ“Š ë³€ê²½ í†µê³„\n`;
            overallReview += `- **ì´ íŒŒì¼ ìˆ˜**: ${summary.total}ê°œ\n`;
            overallReview += `- **ì¶”ê°€ëœ ë¼ì¸**: +${summary.additions}\n`;
            overallReview += `- **ì‚­ì œëœ ë¼ì¸**: -${summary.deletions}\n`;
            overallReview += `- **ì¹´í…Œê³ ë¦¬ë³„**: ${summary.categories.join(', ')}\n\n`;

            // ëª¨ë“  íŒŒì¼ ë³€ê²½ì‚¬í•­ì„ í•˜ë‚˜ì˜ ìš”ì²­ìœ¼ë¡œ í†µí•©
            overallReview += `## ğŸ“ ì½”ë“œ ë¦¬ë·°\n\n`;

            // ì „ì²´ ë³€ê²½ì‚¬í•­ì„ í•œë²ˆì— ìˆ˜ì§‘
            let allChanges = '';
            const filesSummary = [];

            for (const file of filesToReview) {
              filesSummary.push(`- ${file.filename} (+${file.additions}/-${file.deletions})`);
              allChanges += `\n### ${file.filename}\n`;
              allChanges += `\`\`\`diff\n${file.patch}\n\`\`\`\n`;
            }

            console.log('Sending single API request for all files...');

            try {
              const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: 'openrouter/sonoma-sky-alpha',
                  messages: [{
                    role: 'system',
                    content: `ë‹¹ì‹ ì€ AI Counseling App React Native í”„ë¡ íŠ¸ì—”ë“œì˜ ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤.
                    ì´ í”„ë¡œì íŠ¸ëŠ” Expo + React Native + TypeScriptë¡œ êµ¬í˜„ëœ AI ì² í•™ì ìƒë‹´ ëª¨ë°”ì¼ ì•±ì…ë‹ˆë‹¤.

                    ## ğŸ”´ í•„ìˆ˜ ì²´í¬ ì‚¬í•­

                    1. **Expo Router íŒ¨í„´**
                       - app/ í´ë” ë‚´ íŒŒì¼ ê¸°ë°˜ ë¼ìš°íŒ…
                       - _layout.tsxë¡œ ë ˆì´ì•„ì›ƒ ì •ì˜
                       - (group) í´ë”ë¡œ URL ì—†ëŠ” ê·¸ë£¹í™”
                       - [param].tsxë¡œ ë™ì  ë¼ìš°íŒ…

                    2. **React Native ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤**
                       - StyleSheet.create() ì‚¬ìš© (ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì§€ì–‘)
                       - Platform.OSë¡œ í”Œë«í¼ë³„ ì²˜ë¦¬
                       - React Native Paper ì»´í¬ë„ŒíŠ¸ í™œìš©
                       - FlatListë¡œ ê¸´ ëª©ë¡ ìµœì í™”

                    3. **ìƒíƒœ ê´€ë¦¬ íŒ¨í„´**
                       - Zustandë¡œ ì „ì—­ ìƒíƒœ ê´€ë¦¬
                       - React Queryë¡œ ì„œë²„ ìƒíƒœ ê´€ë¦¬
                       - AsyncStorageë¡œ í† í° ì €ì¥
                       - React Hook Formìœ¼ë¡œ í¼ ê´€ë¦¬

                    4. **TypeScript ì‚¬ìš©**
                       - ëª¨ë“  props, stateì— íƒ€ì… ì •ì˜
                       - any íƒ€ì… ì‚¬ìš© ê¸ˆì§€
                       - ì ˆëŒ€ ê²½ë¡œ import (@/) ì‚¬ìš©

                    5. **API í†µì‹  íŒ¨í„´**
                       - services/ í´ë”ì— API ë¡œì§ ë¶„ë¦¬
                       - axios ì¸í„°ì…‰í„°ë¡œ í† í° ìë™ ì¶”ê°€
                       - ì—ëŸ¬ ì²˜ë¦¬ íŒ¨í„´ í†µì¼

                    ## ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸

                    #### ğŸ“„ [íŒŒì¼ëª…]
                    âœ… **íŒ¨í„´ ì¤€ìˆ˜**: Expo Router, React Native íŒ¨í„´ ì²´í¬
                    ğŸŸ¢ **Good**: ì˜ ì‘ì„±ëœ ë¶€ë¶„
                    ğŸŸ¡ **Suggest**: ê°œì„  ì œì•ˆ
                    ğŸ”´ **Issue**: ë°˜ë“œì‹œ ìˆ˜ì • í•„ìš”

                    íŠ¹íˆ í™•ì¸:
                    â–¡ StyleSheet.create() ì‚¬ìš©í•˜ëŠ”ê°€?
                    â–¡ TypeScript íƒ€ì… ì •ì˜ê°€ ëª…í™•í•œê°€?
                    â–¡ React Native Paper ì»´í¬ë„ŒíŠ¸ í™œìš©í•˜ëŠ”ê°€?
                    â–¡ ì ˆëŒ€ ê²½ë¡œ import ì‚¬ìš©í•˜ëŠ”ê°€?
                    â–¡ React Query í›… ë„¤ì´ë° ê·œì¹™ (useQuery, useMutation)?
                    â–¡ í•œêµ­ì–´ UI í…ìŠ¤íŠ¸ ì‚¬ìš©í•˜ëŠ”ê°€?`
                  }, {
                    role: 'user',
                    content: `ë‹¤ìŒ PRì˜ ${filesToReview.length}ê°œ íŒŒì¼ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”:

                    ë³€ê²½ëœ íŒŒì¼:
                    ${filesSummary.join('\n')}

                    ì „ì²´ ë³€ê²½ì‚¬í•­:
                    ${allChanges}

                    ê° íŒŒì¼ë³„ë¡œ êµ¬ì²´ì ì¸ ë¦¬ë·°ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.`
                  }],
                  max_tokens: 20000,
                  temperature: 0.3
                })
              });

              if (response.ok) {
                const result = await response.json();
                overallReview += result.choices[0].message.content + '\n\n';
                console.log('âœ… Single API review completed successfully!');
              } else {
                const errorText = await response.text();
                console.error('API request failed:', response.status, errorText);
                overallReview += `> âš ï¸ ë¦¬ë·° ì‹¤íŒ¨: ${response.status} - ${errorText}\n\n`;
              }
            } catch (error) {
              console.error('Error during review:', error);
              overallReview += `> âš ï¸ ë¦¬ë·° ì‹¤íŒ¨: ${error.message}\n\n`;
            }

            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
            overallReview += `## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸\n\n`;
            overallReview += `- [ ] Biome ë¦°íŠ¸ í†µê³¼í•˜ëŠ”ê°€?\n`;
            overallReview += `- [ ] TypeScript íƒ€ì… ì²´í¬ í†µê³¼í•˜ëŠ”ê°€?\n`;
            overallReview += `- [ ] React Native Paper í…Œë§ˆ ì¼ê´€ì„± ìˆëŠ”ê°€?\n`;
            overallReview += `- [ ] ì ‘ê·¼ì„±(Accessibility) ê³ ë ¤ë˜ì—ˆëŠ”ê°€?\n`;
            overallReview += `- [ ] iOS/Android í”Œë«í¼ë³„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ?\n\n`;

            overallReview += `---\n`;
            overallReview += `*ğŸ¤– AI Review powered by Deepseek 3.1 via OpenRouter*\n`;
            overallReview += `*â±ï¸ Reviewed at: ${new Date().toISOString()}*`;

            // ìµœì¢… ë¦¬ë·° ì œì¶œ
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: overallReview,
              event: 'COMMENT'
            });

            console.log(`âœ… Review completed for ${filesToReview.length} files!`);